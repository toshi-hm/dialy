---
name: fix-review
description: GitHubのPRについたレビューコメントをgh apiコマンドで取得し、各指摘を解析して修正が必要かどうかを判断し、必要な場合はコードの修正案を提示します。PRの番号を指定して実行します。
---

# PR Review Fix Skill

GitHub PRのレビューコメントを取得し、各指摘に対する修正案を提示するスキル。

## 使い方

```
PRのレビューに対応して (#4)
PR #4 のレビューコメントを確認して修正案を出して
```

## 実行手順

### 1. PRレビューコメントの取得

`gh api` コマンドでレビューコメントを取得し、`jq` で必要な情報を抽出する:

```bash
gh api "repos/:owner/:repo/pulls/{PR番号}/comments" --paginate \
  | jq '[.[] | {
    id: .id,
    path: .path,
    start_line: .start_line,
    line: .line,
    body: .body,
    user: .user.login,
    html_url: .html_url,
    created_at: .created_at
  }]'
```

**補足**: `:owner/:repo` は `gh` CLI が自動的にカレントリポジトリの情報に置換する。明示的に指定する場合は `repos/toshi-hm/dialy/pulls/4/comments` のようにする。

### 2. PRレビュー（全体コメント）の取得

PR全体に対するレビューも取得する:

```bash
gh api "repos/:owner/:repo/pulls/{PR番号}/reviews" --paginate \
  | jq '[.[] | {
    id: .id,
    state: .state,
    body: .body,
    user: .user.login,
    submitted_at: .submitted_at
  }]'
```

### 3. 各コメントの分析

取得した各レビューコメントについて以下を判断する:

#### 分類基準

| カテゴリ | 説明 | アクション |
|---|---|---|
| 🔴 **修正必須** | バグ、セキュリティ問題、ロジックエラー | コード修正案を提示 |
| 🟡 **修正推奨** | パフォーマンス改善、可読性向上、ベストプラクティス | 修正案を提示し、対応を検討 |
| 🟢 **対応不要** | スタイルの好み、既に対応済み、誤解に基づく指摘 | 理由を説明 |
| 💬 **質問・確認** | コードの意図を尋ねる質問 | 回答を提示 |

### 4. 対象ファイルの確認

指摘されたファイルと該当行を読み込み、現在のコードの状態を確認する:

- コメントの `path` フィールドから対象ファイルを特定
- `start_line` 〜 `line` の範囲で該当コードを確認
- 指摘内容とコードを照合

### 5. 修正案の提示

修正が必要と判断した場合、以下の形式で修正案を提示する:

```markdown
## レビュー対応結果

### 🔴 修正必須

#### コメント #1 (@reviewer - file.tsx:L45-49)
> レビュアーの指摘内容

**判断**: 修正必須 — 理由の説明

**修正前**:
\`\`\`typescript
// 現在のコード
\`\`\`

**修正後**:
\`\`\`typescript
// 修正案
\`\`\`

---

### 🟡 修正推奨

#### コメント #2 (@reviewer - file.tsx:L119-147)
> レビュアーの指摘内容

**判断**: 修正推奨 — 理由の説明

**修正案**: ...

---

### 🟢 対応不要

#### コメント #3 (@reviewer - file.tsx:L80)
> レビュアーの指摘内容

**判断**: 対応不要 — 理由の説明

---

### 📊 サマリー
- 修正必須: X件
- 修正推奨: X件
- 対応不要: X件
- 質問・確認: X件
```

### 6. 修正の実施

ユーザーの承認後、修正必須・修正推奨のコメントに対してコードを修正する。

## 注意事項

1. **レビュアーの意図を正確に理解する** — 指摘の文脈を十分に把握してから判断する
2. **既に修正済みの指摘を確認する** — コメントが古い場合、すでに対応されている可能性がある
3. **修正の影響範囲を考慮する** — 1つの修正が他のコードに影響しないか確認する
4. **テストへの影響を確認する** — 修正後にテストが壊れないか確認する
5. **botのコメントも対象に含める** — GitHub CopilotなどのBotによるレビューも解析対象とする

## 出力

1. レビューコメントの一覧と各コメントへの判断結果
2. 修正が必要なコメントに対するコード修正案
3. 対応不要と判断したコメントに対する理由
4. 修正後のテスト実行結果（修正を実施した場合）
